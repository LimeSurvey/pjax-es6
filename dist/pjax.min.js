!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).pjax=e()}(this,function(){"use strict";var t,e=function(t){if(null===t||"object"!=typeof t)return t;var e=t.constructor();for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o]);return e},o=function(t,e,o){return t instanceof HTMLCollection||t instanceof NodeList||t instanceof Array?Array.prototype.forEach.call(t,e,o):e.call(o,t)},i=function(t){var e,o=this.options.mainScriptElement,i=t.text||t.textContent||t.innerHTML||"",n=t.src||"",s=t.parentNode||document.querySelector(o)||document.documentElement,a=document.createElement("script");return this.log("Evaluating Script: ",t),i.match("document.write")?(console&&this.options.logObject.log&&this.options.logObject.log("Script contains document.write. Can’t be executed correctly. Code skipped ",t),!1):(e=new Promise(function(t,e){if(a.type="text/javascript",""!=n&&(a.src=n,a.addEventListener("load",function(){t(n)}),a.async=!0),""!=i){try{a.appendChild(document.createTextNode(i))}catch(t){a.text=i}t("text-node")}}),this.log("ParentElement => ",s),s.appendChild(a),s.removeChild(a),["head","body"].indexOf(s.tagName.toLowerCase())>0||this.options.removeScriptsAfterParsing,e)},n=(t=0,function(){var e="pjax"+(new Date).getTime()+"_"+t;return t++,e}),s=function(t,e,i,n){(e="string"==typeof e?e.split(" "):e).forEach(function(e){o(t,function(t){t.addEventListener(e,i,n)})})},a=function(t,e,i){(e="string"==typeof e?e.split(" "):e).forEach(function(e){var n;(n=document.createEvent("HTMLEvents")).initEvent(e,!0,!0),n.eventName=e,i&&Object.keys(i).forEach(function(t){n[t]=i[t]}),o(t,function(t){var e=!1;t.parentNode||t===document||t===window||(e=!0,document.body.appendChild(t)),t.dispatchEvent(n),e&&t.parentNode.removeChild(t)})})},r=function(t){this.options=t,this.options.elements=this.options.elements||"a[href], form[action]",this.options.reRenderCSS=this.options.reRenderCSS||!1,this.options.forceRedirectOnFail=this.options.forceRedirectOnFail||!1,this.options.scriptloadtimeout=this.options.scriptloadtimeout||1e3,this.options.mainScriptElement=this.options.mainScriptElement||"head",this.options.removeScriptsAfterParsing=this.options.removeScriptsAfterParsing||!0,this.options.logObject=this.options.logObject||console,this.options.latestChance=this.options.latestChance||null,this.options.selectors=this.options.selectors||["title",".js-Pjax"],this.options.switches=this.options.switches||{},this.options.switchesOptions=this.options.switchesOptions||{},this.options.history=this.options.history||!0,this.options.onDomDiffers=this.options.onDomDiffers||function(t,e){return!0},this.options.pjaxErrorHandler=this.options.pjaxErrorHandler||function(t,e,o){return!1},this.options.onJsonDocument=this.options.onJsonDocument||function(t){return!0},this.options.analytics=this.options.analytics||function(){window._gaq&&_gaq.push(["_trackPageview"]),window.ga&&ga("send","pageview",{page:location.pathname,title:document.title})},this.options.scrollTo=void 0===this.options.scrollTo?0:this.options.scrollTo,this.options.cacheBust=void 0===this.options.cacheBust||this.options.cacheBust,this.options.debug=this.options.debug||!1,this.options.switches.head||(this.options.switches.head=this.switchElementsAlt),this.options.switches.body||(this.options.switches.body=this.switchElementsAlt),"function"!=typeof t.analytics&&(t.analytics=function(){})},l=function(){this.options.debug&&this.options.logObject&&("function"==typeof this.options.logObject.log?this.options.logObject.log.apply(this.options.logObject,["PJAX ->",arguments]):this.options.logObject.log&&this.options.logObject.log(["PJAX ->",arguments]))},c=function(t){return t.querySelectorAll(this.options.elements)},h=function(t){switch(t.tagName.toLowerCase()){case"a":t.hasAttribute("data-pjax-click-state")||this.attachLink(t);break;case"form":t.hasAttribute("data-pjax-click-state")||this.attachForm(t);break;default:throw"Pjax can only be applied on <a> or <form> submit"}},u=function(t){o(this.getElements(t),h,this)},p=function(t){switch(t.tagName.toLowerCase()){case"a":t.hasAttribute("data-pjax-click-state")||this.unattachLink(t);break;case"form":t.hasAttribute("data-pjax-click-state")||this.unattachForm(t);break;default:throw"Pjax can only be applied on <a> or <form> submit"}},d=function(t){o(this.getElements(t),p,this)},f=function(t){this.parseDOM(t||document)},m=function(){window.location.reload()};Function.prototype.bind||(Function.prototype.bind=function(t){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var e=Array.prototype.slice.call(arguments,1),o=this,i=function(){},n=function(){return o.apply(this instanceof i&&t?this:t,e.concat(Array.prototype.slice.call(arguments)))};return i.prototype=this.prototype,n.prototype=new i,n});var w="data-pjax-click-state",y=function(t,o){if(o.which>1||o.metaKey||o.ctrlKey||o.shiftKey||o.altKey)t.setAttribute(w,"modifier");else if(t.protocol===window.location.protocol&&t.host===window.location.host)if(t.pathname===window.location.pathname&&t.hash.length>0)t.setAttribute(w,"anchor-present");else if(t.hash&&t.href.replace(t.hash,"")===window.location.href.replace(location.hash,""))t.setAttribute(w,"anchor");else if(t.href!==window.location.href.split("#")[0]+"#"){if(o.preventDefault(),this.options.currentUrlFullReload&&t.href===window.location.href.split("#")[0])return t.setAttribute(w,"reload"),void this.reload();this.options.requestOptions=this.options.requestOptions||{},t.setAttribute(w,"load"),this.loadUrl(t.href,e(this.options))}else t.setAttribute(w,"anchor-empty");else t.setAttribute(w,"external")},b=function(t){return t.defaultPrevented||!1===t.returnValue},g=function(t){var e=this;s(t,"click",function(o){b(o)||y.call(e,t,o)}),s(t,"keyup",function(o){b(o)||(o.which>1||o.metaKey||o.ctrlKey||o.shiftKey||o.altKey?t.setAttribute("data-pjax-keyup-state","modifier"):13==o.keyCode&&y.call(e,t,o))}.bind(this))},v="data-pjax-submit-state",x=function(t){var o=this;s(t,"submit",function(i){(function(t){return t.defaultPrevented||!1===t.returnValue})(i)||function(t,o){this.options.requestOptions={requestUrl:t.getAttribute("action")||window.location.href,requestMethod:t.getAttribute("method")||"GET"};var i=document.createElement("a");if(i.setAttribute("href",this.options.requestOptions.requestUrl),i.protocol===window.location.protocol&&i.host===window.location.host)if(i.pathname===window.location.pathname&&i.hash.length>0)t.setAttribute(v,"anchor-present");else if(i.href!==window.location.href.split("#")[0]+"#")if(this.options.currentUrlFullReload)t.setAttribute(v,"reload");else{o.preventDefault();var n=[],s=[];for(var a in t.elements){var r=t.elements[a];if(r.name&&void 0!==r.attributes&&"button"!==r.tagName.toLowerCase()&&("checkbox"!==r.type&&"radio"!==r.type||r.checked)&&-1===n.indexOf(r.name)){if(n.push(r.name),"select"===String(r.nodeName).toLowerCase()&&1==r.multiple){var l=Array.from(r.options).map(function(t,e){return t.selected?t.value:null});return void s.push({name:encodeURIComponent(r.name),value:l})}s.push({name:encodeURIComponent(r.name),value:encodeURIComponent(r.value)})}}var c=s.map(function(t){return t.name+"="+t.value}).join("&");this.options.requestOptions.requestPayload=s,this.options.requestOptions.requestPayloadString=c,t.setAttribute(v,"submit"),this.loadUrl(i.href,e(this.options))}else t.setAttribute(v,"anchor-empty");else t.setAttribute(v,"external")}.call(o,t,i)})},A=function(t,e,i,n){(e="string"==typeof e?e.split(" "):e).forEach(function(e){o(t,function(t){t.removeEventListener(e,i,n)})})},j="data-pjax-click-state",E=function(t,o){if(o.which>1||o.metaKey||o.ctrlKey||o.shiftKey||o.altKey)t.setAttribute(j,"modifier");else if(t.protocol===window.location.protocol&&t.host===window.location.host)if(t.pathname===window.location.pathname&&t.hash.length>0)t.setAttribute(j,"anchor-present");else if(t.hash&&t.href.replace(t.hash,"")===window.location.href.replace(location.hash,""))t.setAttribute(j,"anchor");else if(t.href!==window.location.href.split("#")[0]+"#"){if(o.preventDefault(),this.options.currentUrlFullReload&&t.href===window.location.href.split("#")[0])return t.setAttribute(j,"reload"),void this.reload();this.options.requestOptions=this.options.requestOptions||{},t.setAttribute(j,"load"),this.loadUrl(t.href,e(this.options))}else t.setAttribute(j,"anchor-empty");else t.setAttribute(j,"external")},S=function(t){return t.defaultPrevented||!1===t.returnValue},k=function(t){var e=this;A(t,"click",function(o){S(o)||E.call(e,t,o)}),A(t,"keyup",function(o){S(o)||(o.which>1||o.metaKey||o.ctrlKey||o.shiftKey||o.altKey?t.setAttribute("data-pjax-keyup-state","modifier"):13==o.keyCode&&E.call(e,t,o))}.bind(this))},q="data-pjax-click-state",C=function(t,o){this.options.requestOptions={requestUrl:t.getAttribute("action")||window.location.href,requestMethod:t.getAttribute("method")||"GET"};var i=document.createElement("a");if(i.setAttribute("href",this.options.requestOptions.requestUrl),i.protocol===window.location.protocol&&i.host===window.location.host)if(i.pathname===window.location.pathname&&i.hash.length>0)t.setAttribute(q,"anchor-present");else if(i.href!==window.location.href.split("#")[0]+"#")if(this.options.currentUrlFullReload)t.setAttribute(q,"reload");else{o.preventDefault();var n=[],s=[];for(var a in t.elements){var r=t.elements[a];r.name&&void 0!==r.attributes&&"button"!==r.tagName.toLowerCase()&&("checkbox"!==r.type&&"radio"!==r.type||r.checked)&&-1===n.indexOf(r.name)&&(n.push(r.name),s.push({name:encodeURIComponent(r.name),value:encodeURIComponent(r.value)}))}var l=s.map(function(t){return t.name+"="+t.value}).join("&");this.options.requestOptions.requestPayload=s,this.options.requestOptions.requestPayloadString=l,t.setAttribute(q,"submit"),this.loadUrl(i.href,e(this.options))}else t.setAttribute(q,"anchor-empty");else t.setAttribute(q,"external")},O=function(t){return t.defaultPrevented||!1===t.returnValue},N=function(t){var e=this;A(t,"submit",function(o){O(o)||C.call(e,t,o)}),A(t,"keyup",function(o){O(o)||13==o.keyCode&&C.call(e,t,o)}.bind(this))},P=function(t,e){this.log("styleheets old elements",e),this.log("styleheets new elements",t);o(t,function(t,o){if(null!==function(t){for(var e=[],o=t.length;o--;e.unshift(t[o]));return e}(e).reduce(function(e,o){return e=o.href===t.href?o:e},null))this.log&&this.log("old stylesheet found not resetting");else{this.log&&this.log("new stylesheet => add to head");var i=document.getElementsByTagName("head")[0],n=document.createElement("link");n.setAttribute("href",t.href),n.setAttribute("rel","stylesheet"),n.setAttribute("type","text/css"),i.appendChild(n)}},this)},T={outerHTML:function(t,e){t.outerHTML=e.outerHTML,this.onSwitch()},innerHTML:function(t,e){t.innerHTML=e.innerHTML,t.className=e.className,this.onSwitch()},sideBySide:function(t,e,o,i){var n=Array.prototype.forEach,a=[],r=[],l=document.createDocumentFragment(),c="animationend webkitAnimationEnd MSAnimationEnd oanimationend",h=0,u=function(t){t.target==t.currentTarget&&--h<=0&&a&&(a.forEach(function(t){t.parentNode&&t.parentNode.removeChild(t)}),r.forEach(function(t){t.className=t.className.replace(t.getAttribute("data-pjax-classes"),""),t.removeAttribute("data-pjax-classes")}),r=null,a=null,this.onSwitch())}.bind(this);i=i||{},n.call(t.childNodes,function(t){a.push(t),t.classList&&!t.classList.contains("js-Pjax-remove")&&(t.hasAttribute("data-pjax-classes")&&(t.className=t.className.replace(t.getAttribute("data-pjax-classes"),""),t.removeAttribute("data-pjax-classes")),t.classList.add("js-Pjax-remove"),i.callbacks&&i.callbacks.removeElement&&i.callbacks.removeElement(t),i.classNames&&(t.className+=" "+i.classNames.remove+" "+(o.backward?i.classNames.backward:i.classNames.forward)),h++,s(t,c,u,!0))}),n.call(e.childNodes,function(t){if(t.classList){var e="";i.classNames&&(e=" js-Pjax-add "+i.classNames.add+" "+(o.backward?i.classNames.forward:i.classNames.backward)),i.callbacks&&i.callbacks.addElement&&i.callbacks.addElement(t),t.className+=e,t.setAttribute("data-pjax-classes",e),r.push(t),l.appendChild(t),h++,s(t,c,u,!0)}}),t.className=e.className,t.appendChild(l)}},L=function(t,e,o){var i=(e=e||{}).requestMethod||"GET",n=e.requestPayloadString||null,s=new XMLHttpRequest;return s.onreadystatechange=function(){4===s.readyState&&(200===s.status?o(s.responseText,s):o(null,s))},this.options.cacheBust&&(t+=(/[?&]/.test(t)?"&":"?")+(new Date).getTime()),s.open(i.toUpperCase(),t,!0),s.setRequestHeader("X-Requested-With","XMLHttpRequest"),null!=e.requestPayloadString&&""!=e.requestPayloadString&&s.setRequestHeader("Content-type","application/x-www-form-urlencoded"),s.send(n),s},U=function(){return window.history&&window.history.pushState&&window.history.replaceState&&!navigator.userAgent.match(/((iPod|iPhone|iPad).+\bOS\s+[1-4]\D|WebApps\/.+CFNetwork)/)};return function(t,e){return t(e={exports:{}},e.exports),e.exports}(function(t){var h=function(t){return this.firstrun=!0,r.apply(this,[t]),this.log("Pjax options",this.options),this.maxUid=this.lastUid=n(),this.parseDOM(document),s(window,"popstate",function(t){if(t.state){var o=e(this.options);o.url=t.state.url,o.title=t.state.title,o.history=!1,o.requestOptions={},t.state.uid<this.lastUid?o.backward=!0:o.forward=!0,this.lastUid=t.state.uid,this.loadUrl(t.state.url,o)}}.bind(this)),this};if(h.prototype={log:l,getElements:c,parseDOM:u,parseDOMtoUnload:d,refresh:f,reload:m,attachLink:g,attachForm:x,unattachLink:k,unattachForm:N,updateStylesheets:P,forEachSelectors:function(t,e,i){return function(t,e,i,n){n=n||document,t.forEach(function(t){o(n.querySelectorAll(t),e,i)})}.bind(this)(this.options.selectors,t,e,i)},switchSelectors:function(t,e,i,n){return function(t,e,i,n,s,a){i.forEach(function(i){var r=n.querySelectorAll(i),l=s.querySelectorAll(i);if((this.log&&this.log("Pjax switch",i,r,l),r.length!==l.length)&&a.onDomDiffers(s,n))throw"DOM doesn’t look the same on new loaded page: ’"+i+"’ - new "+r.length+", old "+l.length;o(r,function(o,n){var s=l[n];this.log&&this.log("newEl",o,"oldEl",s),t[i]?t[i].bind(this)(s,o,a,e[i]):T.outerHTML.bind(this)(s,o,a)},this)},this)}.bind(this)(this.options.switches,this.options.switchesOptions,t,e,i,n)},latestChance:function(t){return window.location.href=t,!1},onSwitch:function(){a(window,"resize scroll")},loadContent:function(t,e){var n=document.implementation.createHTMLDocument("pjax"),s=[Promise.resolve("basic resolve")],r=t.match(/<html[^>]+>/gi);r&&r.length&&(r=r[0].match(/\s?[a-z:]+(?:\=(?:\'|\")[^\'\">]+(?:\'|\"))*/gi)).length&&(r.shift(),r.forEach(function(t){var e=t.trim().split("=");1===e.length?n.documentElement.setAttribute(e[0],!0):n.documentElement.setAttribute(e[0],e[1].slice(1,-1))})),jsonContent=null;try{jsonContent=JSON.parse(t)}catch(t){}if(n.documentElement.innerHTML=t,this.log("load content",n.documentElement.attributes,n.documentElement.innerHTML.length),null!==jsonContent&&(this.log("found JSON document",jsonContent),this.options.onJsonDocument.call(this,jsonContent)),document.activeElement&&!document.activeElement.value)try{document.activeElement.blur()}catch(t){}this.switchSelectors(this.options.selectors,n,document,e),!0===this.options.reRenderCSS&&this.updateStylesheets.call(this,n.querySelectorAll("link[rel=stylesheet]"),document.querySelectorAll("link[rel=stylesheet]"));var l=Array.prototype.slice.call(document.querySelectorAll("[autofocus]")).pop();l&&document.activeElement!==l&&l.focus(),this.options.selectors.forEach(function(t){o(document.querySelectorAll(t),function(t){s.push.apply(s,function(t){this.log("Executing scripts for ",t);var e=[];return void 0===t?Promise.resolve():("script"===t.tagName.toLowerCase()&&i.call(this,t),o(t.querySelectorAll("script"),function(t){t.type&&"text/javascript"!==t.type.toLowerCase()||e.push(i.call(this,t))},this),e)}.call(this,t))},this)},this),this.log("waiting for scriptcomplete",s);var c=null;c=window.setTimeout(function(){a(document,"pjax:scriptcomplete pjax:scripttimeout",e),c=null},this.options.scriptloadtimeout),Promise.all(s).then(function(){null!==c&&(window.clearTimeout(c),a(document,"pjax:scriptcomplete pjax:scriptsuccess",e))},function(){null!==c&&(window.clearTimeout(c),a(document,"pjax:scriptcomplete pjax:scripterror",e))})},doRequest:L,loadUrl:function(t,e){this.log("load href",t,e),a(document,"pjax:send",e),this.doRequest(t,e.requestOptions,function(o,i){if(!1===o||200!==i.status)return a(document,"pjax:complete pjax:error",{options:e,requestData:i,href:t}),e.pjaxErrorHandler(t,e,i);document.activeElement.blur();try{this.loadContent(o,e)}catch(o){if(this.options.debug){if(this.options.forceRedirectOnFail)return e.pjaxErrorHandler(t,e,i)||this.latestChance(t);throw o}return console&&this.options.logObject.error&&this.options.logObject.error("Pjax switch fail: ",o),e.pjaxErrorHandler(t,e,i)||this.latestChance(t)}e.history&&(this.firstrun&&(this.lastUid=this.maxUid=n(),this.firstrun=!1,window.history.replaceState({url:window.location.href,title:document.title,uid:this.maxUid},document.title)),this.lastUid=this.maxUid=n(),window.history.pushState({url:t,title:e.title,uid:this.maxUid},e.title,t)),this.forEachSelectors(function(t){this.parseDOM(t)},this),a(document,"pjax:complete pjax:success",e),e.analytics(),!1!==e.scrollTo&&(e.scrollTo.length>1?window.scrollTo(e.scrollTo[0],e.scrollTo[1]):window.scrollTo(0,e.scrollTo))}.bind(this))}},h.isSupported=U,h.isSupported())t.exports=h;else{var p=function(){};for(var w in h.prototype)h.prototype.hasOwnProperty(w)&&"function"==typeof h.prototype[w]&&(p[w]=p);t.exports=p}})});
